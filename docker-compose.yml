# Docker Compose configuration for music tracking application
# Optimized for ~2GB RAM deployments with local-only access
# Memory allocation strategy (rough guide):
# - Metabase: 600MB (JVM with 512MB heap)
# - Data Pipeline: 400MB (ETL processing)
# - n8n: 300MB (UI + orchestration)
# - n8n task runners: 350MB (Python Code node runtime)
# - Total: ~1.65GB (within 2GB budget)
# Local-only access: Metabase on port 3000, n8n on port 5678

services:
  # Main data processing and dbt service
  data-pipeline:
    build: .
    container_name: music-tracker-pipeline
    volumes:
      - ./data:/app/data
      - ./dbt:/app/dbt
      - ./flows:/app/flows
      - ./scripts:/app/scripts
      - ./logs:/app/logs
    env_file: .env
    environment:
      - DUCKDB_PATH=/app/data/music_tracker.duckdb
      - LOG_LEVEL=INFO
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # 400MB max, 250MB reservation for data processing overhead
    mem_limit: 400m
    mem_reservation: 250m

  # Metabase for reporting
  metabase:
    build:
      context: .
      dockerfile: metabase.Dockerfile
    container_name: music-tracker-metabase
    ports:
      - "3000:3000"
    volumes:
      - metabase-data:/home
      - ./data:/data
    env_file: .env
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/home/metabase.db
      - MB_PLUGINS_DIR=/home/plugins/
      - JAVA_OPTS=-Xmx512m -Xms256m -XX:+UseG1GC
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # 600MB max, 400MB reservation provides headroom for JVM overhead
    mem_limit: 600m
    mem_reservation: 400m

  # n8n for workflow orchestration
  n8n:
    image: n8nio/n8n:2.2.3
    container_name: music-tracker-n8n
    ports:
      - "5678:5678"
    env_file: .env
    environment:
      # Basic n8n config
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - WEBHOOK_URL=http://${N8N_HOST:-localhost}:5678/
      - GENERIC_TIMEZONE=${TIMEZONE:-UTC}
      # Execution timeouts
      - EXECUTIONS_TIMEOUT=-1
      - EXECUTIONS_TIMEOUT_MAX=-1
      # Task runners config
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=1800000
      - N8N_RUNNERS_TASK_TIMEOUT=3600
      - N8N_RUNNERS_TASK_MAX_TIMEOUT=3660
      # Python support and allowed packages
      - PYTHONPATH=/workspace
      - N8N_PYTHON_ALLOWED_MODULES=flows,polars,requests,duckdb,httpx,musicbrainzngs,pyarrow,pycountry,pycountry_convert,python_dateutil,structlog,python_dotenv,dbt
      - N8N_RUNNERS_PYTHON_ALLOWED_MODULES=flows,polars,requests,duckdb,httpx,musicbrainzngs,pyarrow,pycountry,pycountry_convert,python_dateutil,structlog,python_dotenv,dbt
    volumes:
      - n8n-data:/home/node/.n8n
      - ./n8n-workflows:/workflows
      - ./:/workspace
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # ~300MB for n8n (improvement over Prefect's 400MB server + 200MB DB)
    mem_limit: 300m
    mem_reservation: 200m

  # n8n task runners (required for Python (Native) Code node)
  task-runners:
    build:
      context: .
      dockerfile: task-runners.Dockerfile
    container_name: music-tracker-n8n-runners
    restart: always
    env_file: .env
    environment:
      # Core n8n runner config
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:5679
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
      - GENERIC_TIMEZONE=${TIMEZONE:-UTC}
      - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=1800000
      - N8N_RUNNERS_TASK_TIMEOUT=3600 
      - N8N_RUNNERS_TASK_MAX_TIMEOUT=3660
      # Application-specific paths
      - DBT_PROFILES_DIR=/home/runner/workspace/dbt
      - DUCKDB_PATH=/home/runner/workspace/data/music_tracker.duckdb
      - PYTHONPATH=/home/runner/workspace
      # Spotify credentials
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
      - SPOTIFY_REFRESH_TOKEN=${SPOTIFY_REFRESH_TOKEN}
      # DuckDB memory limit
      - DUCKDB_MEMORY_LIMIT=800MB
    volumes:
      - ./.env:/home/runner/workspace/.env:ro
      - ./data:/home/runner/workspace/data
      - ./flows:/home/runner/workspace/flows
      - ./dbt:/home/runner/workspace/dbt
      - ./scripts:/home/runner/workspace/scripts
      - ./logs:/home/runner/workspace/logs
      - ./n8n-workflows:/home/runner/workspace/n8n-workflows
      - n8n-data:/home/node/.n8n
    networks:
      - music-tracker
    depends_on:
      - n8n
    mem_limit: 1024m
    mem_reservation: 512m

volumes:
  metabase-data:
  n8n-data:

networks:
  music-tracker:
    driver: bridge