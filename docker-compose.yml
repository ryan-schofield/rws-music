# Docker Compose configuration for music tracking application
# Optimized for 2GB RAM Synology NAS deployment with local-only access
# Memory allocation strategy:
# - Prefect Server: 400MB (orchestration)
# - Prefect Worker: 300MB (task execution)
# - Prefect DB: 200MB (PostgreSQL with tuning)
# - Metabase: 600MB (JVM with 512MB heap)
# - Data Pipeline: 400MB (ETL processing)
# - Total: ~1.9GB (within 2GB budget)
# Local-only access: Metabase on port 3000, Prefect on port 4200 (LAN access only)

services:
  # Main data processing and dbt service
  data-pipeline:
    build: .
    container_name: music-tracker-pipeline
    volumes:
      - ./data:/app/data
      - ./dbt:/app/dbt
      - ./flows:/app/flows
      - ./scripts:/app/scripts
      - ./logs:/app/logs
    env_file: .env
    environment:
      - DUCKDB_PATH=/app/data/music_tracker.duckdb
      - LOG_LEVEL=INFO
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # 400MB max, 250MB reservation for data processing overhead
    mem_limit: 400m
    mem_reservation: 250m

  # Metabase for reporting
  metabase:
    build:
      context: .
      dockerfile: metabase.Dockerfile
    container_name: music-tracker-metabase
    ports:
      - "3000:3000"
    volumes:
      - metabase-data:/home
      - ./data:/data
    env_file: .env
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/home/metabase.db
      - MB_PLUGINS_DIR=/home/plugins/
      - JAVA_OPTS=-Xmx512m -Xms256m -XX:+UseG1GC
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # 600MB max, 400MB reservation provides headroom for JVM overhead
    mem_limit: 600m
    mem_reservation: 400m

  # n8n for workflow orchestration
  n8n:
    image: n8n:latest
    container_name: music-tracker-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - WEBHOOK_URL=http://${N8N_HOST:-localhost}:5678/
      - GENERIC_TIMEZONE=${TIMEZONE:-UTC}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./n8n-workflows:/workflows
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # ~300MB for n8n (improvement over Prefect's 400MB server + 200MB DB)
    mem_limit: 300m
    mem_reservation: 200m

volumes:
  metabase-data:
  n8n-data:

networks:
  music-tracker:
    driver: bridge