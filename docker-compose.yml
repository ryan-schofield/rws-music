# Docker Compose configuration for music tracking application
# Optimized for 2GB RAM Synology NAS deployment with local-only access
# Memory allocation strategy (Post-Prefect Migration):
# - n8n: 300MB (workflow orchestration)
# - Metabase: 600MB (JVM with 512MB heap)
# - Data Pipeline: 400MB (ETL processing - can be increased to 600MB if needed)
# - Total: ~1.3GB (700MB freed from Prefect removal, available for scaling)
# Local-only access: Metabase on port 3000, n8n on port 5678 (LAN access only)

services:
  # Main data processing and dbt service
  data-pipeline:
    build: .
    container_name: music-tracker-pipeline
    volumes:
      - ./data:/app/data
      - ./dbt:/app/dbt
      - ./flows:/app/flows
      - ./scripts:/app/scripts
      - ./logs:/app/logs
    env_file: .env
    environment:
      - DUCKDB_PATH=/app/data/music_tracker.duckdb
      - LOG_LEVEL=INFO
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # 400MB max, 250MB reservation for data processing overhead
    mem_limit: 400m
    mem_reservation: 250m

  # Metabase for reporting
  metabase:
    build:
      context: .
      dockerfile: metabase.Dockerfile
    container_name: music-tracker-metabase
    ports:
      - "3000:3000"
    volumes:
      - metabase-data:/home
      - ./data:/data
    env_file: .env
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/home/metabase.db
      - MB_PLUGINS_DIR=/home/plugins/
      - JAVA_OPTS=-Xmx512m -Xms256m -XX:+UseG1GC
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # 600MB max, 400MB reservation provides headroom for JVM overhead
    mem_limit: 600m
    mem_reservation: 400m

  # n8n for workflow orchestration
  n8n:
    build:
      context: .
      dockerfile: n8n.Dockerfile
    container_name: music-tracker-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - WEBHOOK_URL=http://${N8N_HOST:-localhost}:5678/
      - GENERIC_TIMEZONE=${TIMEZONE:-UTC}
      - TZ=${TIMEZONE:-UTC}
      # Task runner configuration
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=external
      - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
      - N8N_RUNNERS_AUTH_TOKEN=your-secret-runner-token
      - N8N_NATIVE_PYTHON_RUNNER=true
    volumes:
      - n8n-data:/home/node/.n8n
      - ./data:/app/data
      - ./flows:/app/flows
      - ./dbt:/app/dbt
      - ./logs:/app/logs
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for 2GB RAM Synology NAS
    # ~300MB for n8n (improvement over Prefect's 400MB server + 200MB DB)
    mem_limit: 300m
    mem_reservation: 200m

  # Task runners for Python and JavaScript code execution
  task-runners:
    build:
      context: .
      dockerfile: runners.Dockerfile
    container_name: music-tracker-task-runners
    volumes:
      - ./data:/app/data
      - ./flows:/app/flows
      - ./dbt:/app/dbt
      - ./logs:/app/logs
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:5679
      - N8N_RUNNERS_AUTH_TOKEN=your-secret-runner-token
      - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=15
      - N8N_RUNNERS_CONFIG_FILE=/etc/n8n/task-runners.json
      - N8N_RUNNERS_LAUNCHER_WORKING_DIRECTORY=/tmp/n8n-runners
      - N8N_RUNNERS_LAUNCHER_WORK_DIR=/tmp/n8n-runners
      - N8N_RUNNERS_LAUNCHER_DEFAULT_DIR=/tmp/n8n-runners
    networks:
      - music-tracker
    restart: unless-stopped
    # Memory limits for task runners
    # Reserve 200MB for Python/JS task execution
    mem_limit: 200m
    mem_reservation: 100m

volumes:
  metabase-data:
  n8n-data:

networks:
  music-tracker:
    driver: bridge