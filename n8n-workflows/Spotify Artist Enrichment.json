{
  "name": "Spotify Artist Enrichment",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -896,
        -64
      ],
      "id": "4c7a3a79-0d9c-444d-a135-c1817980dad2",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_spotify_artists_granular import IdentifyMissingArtistsCLI\nreturn IdentifyMissingArtistsCLI().execute(limit=50, batch_size=10)"
      },
      "name": "Identify Missing Artists",
      "type": "n8n-nodes-base.code",
      "position": [
        -672,
        -64
      ],
      "typeVersion": 2,
      "id": "acbbce4a-810b-442c-a7b5-dd26db603732",
      "notes": "Uses DuckDB to efficiently identify missing artists and create batch plan"
    },
    {
      "parameters": {
        "fieldToSplitOut": "data.batches",
        "options": {}
      },
      "name": "Split Into Batches",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        -448,
        -64
      ],
      "typeVersion": 1,
      "id": "f3d08354-69c8-4254-9ace-d8ad5e8cc25c",
      "notes": "Splits the batch plan into individual batch items for parallel processing"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_spotify_artists_granular import FetchArtistBatchCLI\n\nbatch_index = _item[\"json\"][\"batch_index\"]\noffset = _item[\"json\"][\"offset\"]\nbatch_size = _item[\"json\"][\"size\"]\n\nreturn FetchArtistBatchCLI().execute(\n    batch_index=batch_index,\n    offset=offset,\n    batch_size=batch_size\n)"
      },
      "name": "Fetch Artist Batch",
      "type": "n8n-nodes-base.code",
      "position": [
        -224,
        -64
      ],
      "typeVersion": 2,
      "id": "bb459d97-6ef2-4c16-bcc1-aaff4ffdeafc",
      "notes": "Fetches artist data from Spotify API for this specific batch"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_spotify_artists_granular import WriteArtistDataCLI\n\nartist_data = _item[\"json\"][\"data\"][\"artist_data\"]\n\nartist_out = WriteArtistDataCLI().execute(artist_data=artist_data)\nartist_out[\"artist_data\"] = artist_data\n\nreturn artist_out"
      },
      "name": "Write Artist Data",
      "type": "n8n-nodes-base.code",
      "position": [
        0,
        -64
      ],
      "typeVersion": 2,
      "id": "06996611-fa13-4377-a2ea-cb09e30f9bcd",
      "notes": "Writes artist data to spotify_artists parquet table using merge mode"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_spotify_artists_granular import ExtractArtistGenresCLI\n\nartist_data = _item[\"json\"][\"artist_data\"]\n\nreturn ExtractArtistGenresCLI().execute(artist_data=artist_data)"
      },
      "name": "Extract Artist Genres",
      "type": "n8n-nodes-base.code",
      "position": [
        224,
        -64
      ],
      "typeVersion": 2,
      "id": "407c858a-b959-4fdd-9eac-84e332949f8f",
      "notes": "Extracts genre data and writes to spotify_artist_genre parquet table"
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Identify Missing Artists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Identify Missing Artists": {
      "main": [
        [
          {
            "node": "Split Into Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Into Batches": {
      "main": [
        [
          {
            "node": "Fetch Artist Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Artist Batch": {
      "main": [
        [
          {
            "node": "Write Artist Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Artist Data": {
      "main": [
        [
          {
            "node": "Extract Artist Genres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "85071731-4e07-4b84-a2ff-d800138be8e0",
  "meta": {
    "instanceId": "03f02996677a6277d4986d4c62e9b1f4a2889034d3039e11223e4a810823d82a"
  },
  "id": "spvwtVRX_wv7aLJrTkxqJ",
  "tags": []
}