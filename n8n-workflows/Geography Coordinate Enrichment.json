{
  "name": "Geography Coordinate Enrichment",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "2ebfee0d-d78d-49a5-a47e-a6cff577c58b",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_geography_coordinates_granular import IdentifyCitiesNeedingCoordinatesCLI\nreturn IdentifyCitiesNeedingCoordinatesCLI().execute(limit=500, batch_size=50)"
      },
      "name": "Identify Cities Needing Coordinates",
      "type": "n8n-nodes-base.code",
      "position": [
        224,
        0
      ],
      "typeVersion": 2,
      "id": "0d0b0365-be7c-4ff9-9002-6770ecc5240a",
      "notes": "Uses DuckDB to efficiently identify cities needing coordinate lookup and create batch plan"
    },
    {
      "parameters": {
        "fieldToSplitOut": "data.batches",
        "options": {}
      },
      "name": "Split Into Batches",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        448,
        0
      ],
      "typeVersion": 1,
      "id": "90cd6f67-92fe-41ae-a0b5-abe5332df4c0",
      "notes": "Splits the batch plan into individual batch items for parallel processing"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_geography_coordinates_granular import FetchCoordinateBatchCLI\n\nbatch_index = _item[\"json\"][\"batch_index\"]\nbatch_size = _item[\"json\"][\"batch_size\"]\noffset = _item[\"json\"][\"offset\"]\n\nreturn FetchCoordinateBatchCLI().execute(\n    batch_index=batch_index,\n    batch_size=batch_size,\n    offset=offset\n)"
      },
      "name": "Fetch Coordinate Batch",
      "type": "n8n-nodes-base.code",
      "position": [
        672,
        0
      ],
      "typeVersion": 2,
      "id": "73f848dd-2601-41a0-aac3-30f095a1e2f0",
      "notes": "Fetches coordinates from OpenWeather API for this specific batch"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "language": "pythonNative",
        "pythonCode": "from flows.cli.enrich_geography_coordinates_granular import WriteCoordinateDataCLI\n\ncoordinate_data = _item[\"json\"][\"data\"][\"coordinate_data\"]\n\nreturn WriteCoordinateDataCLI().execute(coordinate_data=coordinate_data)"
      },
      "name": "Write Coordinate Data",
      "type": "n8n-nodes-base.code",
      "position": [
        896,
        0
      ],
      "typeVersion": 2,
      "id": "3194ac07-17d7-4aa5-ad13-d87e291b0e91",
      "notes": "Writes coordinate data to cities_with_lat_long parquet table using merge mode"
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Identify Cities Needing Coordinates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Identify Cities Needing Coordinates": {
      "main": [
        [
          {
            "node": "Split Into Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Into Batches": {
      "main": [
        [
          {
            "node": "Fetch Coordinate Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Coordinate Batch": {
      "main": [
        [
          {
            "node": "Write Coordinate Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "8ae3af44-6a8b-4f3d-8e0f-8ad8c8aebded",
  "meta": {
    "instanceId": "fe0cdcb4af99c360c90455b1f1007a24ba2abc365db532c71df5662d52925885"
  },
  "id": "JSwOOALUm8EQcFveF-kKw",
  "tags": []
}